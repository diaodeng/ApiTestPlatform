import{T as W,F as _e,ar as Ve,as as de,r as h,D as Ee,at as D,d as g,o as k,c as H,e as a,h as t,f as o,i as O,m as E,au as Me,p as I,n as L,q as ue,av as Re,aw as qe,K as pe,E as Ue,a3 as Z,z as Fe,B as Pe,C as ye,G as F,L as $e,y as Be,s as ze,a8 as Ie}from"./index.D1UU-JKR.js";import{C as He,a as Oe,S as Le,b as We,c as Ke,_ as je,g as Ge}from"./run-detail.CW5gpYJf.js";import{_ as Qe}from"./edit-label-text.DOrTnJ2W.js";import{C,H as P,r as Xe,R as Ye}from"./project.BEKQUXYm.js";import{r as Je}from"./tools.CngWgkPu.js";import{_ as Ze}from"./run_detail.VJK9822J.js";import"./data-template.wQZkSKNf.js";import{g as et,d as tt}from"./case.mB6yUI8P.js";import"./table-variables.BIEEewK4.js";import"./ace-editor.C0dgdm4x.js";import"./ResizeObserver.es.B1PUzC5B.js";import"./module.CT62IJ3Y.js";import"./env.BPRS9T69.js";function lt(x){return W({url:"/hrm/api/mult/tree",method:"get",params:x})}function at(x){return W({url:"/hrm/api/detail/"+x,method:"get"})}function se(x){return W({url:"/hrm/api",method:"post",data:x})}function re(x){return W({url:"/hrm/api",method:"put",data:x})}function nt(x){return W({url:"/hrm/api/"+x,method:"delete"})}function ot(x){return W({url:"/hrm/api/copyAsCase",method:"post",data:x})}const it=["onDblclick","onClick","onMouseenter","onMouseleave"],dt={key:4},st=_e({__name:"tree-view",props:{dataSource:{},dataSourceModifiers:{},filterText:{},filterTextModifiers:{},treeRef:{},treeRefModifiers:{}},emits:Ve(["nodeDbClick","delNode","filter","addNode","moveNode","editNode","currentNodeChange"],["update:dataSource","update:filterText","update:treeRef"]),setup(x,{emit:G}){const ee=de(x,"dataSource");de(x,"filterText");const te=de(x,"treeRef"),V=h({e:null,data:null,node:null,nodeRef:null}),S=Ee({show:!1,x:0,y:0,data:[{title:"新增文件夹",apiType:C.folder,icon:"Menu"},{title:"新增http请求",apiType:C.http,icon:"Menu",divided:!0},{title:"新增websocket请求",apiType:C.websocket,icon:"Menu",divided:!0}],onSelect:s=>{B(V.value.data,s.apiType)}}),M=G,$=(s,i,u,T)=>{};function p(s,i,u,T){s.preventDefault(),V.value.e=s,V.value.data=i,V.value.node=u,V.value.nodeRef=T,S.x=s.clientX,S.y=s.clientY,S.show=!0}const f={key:"apiId",children:"children",label:"name",isLeaf:"isParent",parentId:"parentId"},B=(s,i)=>{if(!s.isParent){D.warning("只能在文件夹中新增节点");return}const u=Je(10),_={id:null,name:"新增API",children:[],isNew:!0,apiId:u,isParent:i===C.folder,parentId:s.apiId,type:i!==C.folder?P.api:P.folder,apiType:i,edit:!1};s.children||(s.children=[]),s.children.splice(0,0,_),M("addNode",i,_,s)},w=(s,i,u)=>{Ue.confirm(`确定删除吗？
对应目录下的所有内容都将被删除`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{console.log(u),nt(u.apiId).then(T=>{const _=i.parent,v=_.data.children||_.data,y=v.findIndex(m=>m.apiId===u.apiId);v.splice(y,1),D.success("删除成功"),M("delNode",u)}).catch(()=>{})}).catch(()=>{})},K=(s,i,u)=>{M("nodeDbClick",s,i,u)};function R(s,i,u){return!s||i.name.indexOf(s)!==-1||i.title.indexOf(s)!==-1}const z=(s,i)=>{},r=(s,i,u)=>{},q=(s,i,u)=>{},N=(s,i,u)=>{console.log("tree drag over:",i.label)},U=(s,i,u,T)=>{if(u==="none")return!1},Q=(s,i,u,T)=>{let _=null,v=s.data.apiId,y=0;u==="inner"?_=i.data.apiId:(u==="after"||u==="before")&&(_=i.parent.data.apiId),_!==v&&M("moveNode",_,v,y)},X=(s,i,u)=>!(!i.data.isParent&&u==="inner"||i.data.apiId===s.data.apiId),le=(s,i,u)=>{M("editNode",s,i,u)},j=(s,i)=>{M("currentNodeChange",s,i)};return(s,i)=>{const u=g("el-icon"),T=g("el-button"),_=g("el-tree");return k(),H(pe,null,[a(He,{visible:t(S).show,"onUpdate:visible":i[0]||(i[0]=v=>t(S).show=v),x:t(S).x,y:t(S).y,onSelect:t(S).onSelect,menus:t(S).data},null,8,["visible","x","y","onSelect","menus"]),a(_,{style:{"max-width":"600px"},data:ee.value,"highlight-current":"",props:f,"node-key":"apiId","expand-on-click-node":!1,ref_key:"treeRef",ref:te,"filter-node-method":R,onNodeContextmenu:p,draggable:"","allow-drop":X,onNodeDragStart:z,onNodeDragEnter:r,onNodeDragLeave:q,onNodeDragOver:N,onNodeDragEnd:U,onNodeDrop:Q,onCurrentChange:j},{default:o(({node:v,data:y})=>[O("span",{onDblclick:m=>{K(m,v,y)},onClick:m=>{$(y,v,m)},onMouseenter:m=>{v.data.edit=!0},onMouseleave:m=>{v.data.edit=!1}},[y.apiType===t(C).folder?(k(),E(u,{key:0},{default:o(()=>[a(t(Me))]),_:1})):y.apiType===t(C).http?(k(),E(T,{key:1,type:"success",link:""},{default:o(()=>i[1]||(i[1]=[I("RQ")])),_:1})):y.apiType===t(C).websocket?(k(),E(T,{key:2,type:"primary",link:""},{default:o(()=>i[2]||(i[2]=[I("WS")])),_:1})):y.apiType===t(C).webui?(k(),E(T,{key:3,type:"warning",link:""},{default:o(()=>i[3]||(i[3]=[I("WB")])),_:1})):L("",!0),O("span",null,[a(Qe,{content:y.name,"onUpdate:content":m=>y.name=m,"show-edite":v.data.edit,"onUpdate:showEdite":m=>v.data.edit=m,onEdite:m=>{le(m,y,v)}},null,8,["content","onUpdate:content","show-edite","onUpdate:showEdite","onEdite"])]),v.data.edit?(k(),H("span",dt,[y.apiType===t(C).folder?(k(),E(u,{key:0,color:"green",onClick:ue(m=>{p(m,y,v)},["stop"])},{default:o(()=>[a(t(Re))]),_:2},1032,["onClick"])):L("",!0),a(u,{color:"red",onClick:ue(m=>w(m,v,y),["stop"])},{default:o(()=>[a(t(qe))]),_:2},1032,["onClick"])])):L("",!0)],40,it)]),_:1},8,["data"])],64)}}}),rt={class:"app-container",style:{height:"100%"}},ut={style:{display:"flex"}},pt={style:{margin:"0px",padding:"0px"}},ft=["onDblclick"],ct={key:0,style:{"flex-grow":"1",display:"flex","flex-direction":"column"}},vt=_e({name:"Api"}),Tt=Object.assign(vt,{setup(x){const{proxy:G}=ze(),{sys_normal_disable:ee}=G.useDict("sys_normal_disable"),{hrm_data_type:te}=G.useDict("hrm_data_type");Z("hrm_data_type",te),Z("sys_normal_disable",ee);const V=h([]),S=h({}),M=h({}),$=h({parentId:null,name:null}),p=h([]),f=h(p.value[0]||null),B=h(""),w=h(0),K=h({runHistoryDialog:!1}),R=h(!1),z=h(!0),r=h({page:!1,loadApiTree:!1,loadApiInfo:!1,saveApi:!1,debugApi:!1,preSaveDialog:!1,preSaveFolderDialog:!1,filter:!1}),q=h(""),N=h(null),U=h();Fe(()=>{j(),et().then(l=>{S.value=l.data}),Oe().then(l=>{M.value=l.data})}),Z("hrm_comparator_dict",S),Z("hrm_case_config_list",M);function Q(l){r.value.saveApi=!0;let e=Ie(f.value);if(e=structuredClone(e),e.type=P.api,e.requestInfo.teststeps.forEach(n=>{n.result=null}),e.id&&e.apiId&&!e.isNew)l==="copy2case"?ot(e).then(n=>{D({message:"API复制成功",type:"success"})}).catch(n=>{D.error("API复制失败")}).finally(()=>{r.value.saveApi=!1,r.value.preSaveDialog=!1}):re(e).then(n=>{D({message:"API保存成功",type:"success"}),X(n,e.apiId)}).catch(n=>{D({message:"API保存失败",type:"success"})}).finally(()=>{r.value.saveApi=!1,r.value.preSaveDialog=!1});else{const n=e.apiId;delete e.isNew,delete e.apiId,delete e.id,se(e).then(c=>{D({message:"API保存成功",type:"success"}),X(c,n)}).finally(()=>{r.value.saveApi=!1,r.value.preSaveDialog=!1})}}function X(l,e){let n=l;if(n){let c=N.value.getNode(e);c.data.apiId=n.data.apiId,c.data.name=n.data.name,c.data.isNew=!1,c.apiId=n.data.apiId,c.name=n.data.name,p.value.forEach(A=>{A.apiId===e&&(A.apiId=n.data.apiId,w.value=n.data.apiId)})}}function le(){let l=null;U.value&&(l=U.apiId,l=N.value.getNode(l)?l:null),r.value.preSaveFolderDialog=!0;let e=$.value;e.type=P.folder,e.apiType=C.folder,e.parentId=l,se(e).then(n=>{l?N.value.getNode(l).data.children.splice(0,0,n.data):V.value.splice(0,0,n.data),D({message:"Folder保存成功",type:"success"})}).finally(()=>{r.value.preSaveFolderDialog=!1})}function j(){N.value.setCurrentKey(null,!1),R.value=!0,lt({onlySelf:z.value}).then(l=>{V.value=l.data}).finally(()=>{R.value=!1})}function s(l,e,n){if(e.data.isParent)e.expanded=!e.expanded;else{const c=e.data.apiId,A=p.value.findIndex(b=>b.apiId===c);if(A!==-1)w.value=c,f.value=p.value[A],R.value=!1;else{if(R.value=!0,e.data.isNew){let b=Ge(e.data.apiType);b.isNew=!0,b.type=e.data.type,b.apiType=e.data.apiType,b.requestInfo.name=e.name,b.parentId=e.data.parentId,b.apiId=e.data.apiId,p.value.push(b),f.value=p.value[p.value.length-1],w.value=b.apiId,p.value[0].isEmpty&&p.value.splice(0,1),R.value=!1;return}at(e.data.apiId).then(b=>{p.value.push(b.data),f.value=p.value[p.value.length-1],w.value=b.data.apiId,p.value[0].isEmpty&&p.value.splice(0,1),console.log("当前tab："+w.value)}).catch(()=>{}).finally(()=>{R.value=!1})}}}function i(l){const e=p.value.findIndex(n=>n.apiId===l.apiId);e!==-1&&p.value.splice(e,1)}function u(l,e){const n=p.value.findIndex(c=>c.apiId===e);n!==-1&&(p.value.length===1?f.value=!1:p.value.length-1===n?(f.value=p.value[n-1],w.value=f.value.apiId):(f.value=p.value[n+1],w.value=f.value.apiId),p.value.splice(n,1),console.log("删除了tab:"+e))}function T(l,e){}function _(l){const e=p.value.findIndex(n=>n.apiId===l);f.value=p.value[e],w.value=l,N.value.setCurrentKey(l)}function v(){r.value.debugApi=!0;const l=Ie(f.value);let e={request:l.requestInfo,type:l.type,name:l.name,caseId:l.apiId};delete e.request.config.result,delete e.request.teststeps[0].result,e.request.config.name=e.name;const n={env:B.value,runType:Ye.api,caseData:e};tt(n).then(c=>{D.success(c.msg);for(const A in c.data)f.value.requestInfo.teststeps.find(b=>b.step_id===A).result=c.data[A]}).finally(()=>{r.value.debugApi=!1})}function y(){r.value.filter=!0,N.value.filter(q.value),r.value.filter=!1}const m=(l,e,n)=>{re({parentId:l,apiId:e}).then(c=>{D.success("移动节点成功")}).catch(c=>{})},be=(l,e,n)=>{re({name:e.name,apiId:e.apiId}).then(c=>{D.success("修改成功")}).catch(c=>{})},xe=(l,e,n)=>{if(l!==C.folder)return;let c=l===C.folder?P.folder:P.api;se({type:c,apiType:l,name:e.name,parentId:n.apiId}).then(A=>{D.success("文件夹【"+e.name+"】新增成功")}).catch(A=>{})};function he(){if(!f.value){D.warning("请先选择一个接口");return}K.value.runHistoryDialog=!0}function ke(l,e){!l||l&&l.type===P.folder||p.value.findIndex(c=>c.apiId===l.apiId)===-1||(w.value=l.apiId,_(l.apiId))}function Ce(){r.value.preSaveFolderDialog=!0;let l=N.value.getCurrentNode();l&&!l.isParent&&(l=N.value.getNode(l.patentId)),l?U.value=l:U.value=null}return(l,e)=>{var ce,ve,me;const n=g("el-button"),c=g("el-dropdown-item"),A=g("el-dropdown-menu"),b=g("el-dropdown"),ae=g("el-row"),we=g("el-checkbox"),Y=g("el-input"),Ne=g("el-col"),De=g("el-scrollbar"),Se=g("el-badge"),Te=g("el-tab-pane"),Ae=g("el-tabs"),J=g("el-text"),ne=g("el-container"),oe=g("el-main"),ie=g("el-dialog"),fe=Pe("loading");return ye((k(),H("div",rt,[a(ae,null,{default:o(()=>[a(n,{size:"small",onClick:j,icon:"RefreshRight"}),a(n,{size:"small",onClick:Ce,type:"primary"},{default:o(()=>e[21]||(e[21]=[I("新增文件夹")])),_:1}),e[27]||(e[27]=O("span",{style:{"flex-grow":"1"}},null,-1)),ye((k(),E(b,{size:"small","split-button":"",type:"primary",onClick:e[2]||(e[2]=d=>t(r).preSaveDialog=!0),disabled:t(r).saveApi},{dropdown:o(()=>[a(A,null,{default:o(()=>[a(c,{onClick:e[0]||(e[0]=d=>{Q("copy2case")})},{default:o(()=>e[22]||(e[22]=[I("另存为用例")])),_:1}),a(c,{onClick:e[1]||(e[1]=d=>console.log("复制API"))},{default:o(()=>e[23]||(e[23]=[I("复制")])),_:1}),a(c,{onClick:he},{default:o(()=>e[24]||(e[24]=[I("执行历史")])),_:1})]),_:1})]),default:o(()=>[e[25]||(e[25]=I(" 保存 "))]),_:1},8,["disabled"])),[[fe,t(r).saveApi]]),a(n,{size:"small",onClick:v,loading:t(r).debugApi,disabled:t(r).debugApi,type:"warning"},{default:o(()=>e[26]||(e[26]=[I(" 调试 ")])),_:1},8,["loading","disabled"]),a(Ze,{"selected-env":t(B),"onUpdate:selectedEnv":e[3]||(e[3]=d=>F(B)?B.value=d:null),size:"small",disable:t(r).debugApi},null,8,["selected-env","disable"])]),_:1}),a(ne,null,{default:o(()=>[a(Le,{"left-width":"250px","window-height":"calc(100vh - 156px)"},{left:o(()=>[a(ae,null,{default:o(()=>[a(we,{modelValue:t(z),"onUpdate:modelValue":e[4]||(e[4]=d=>F(z)?z.value=d:null),onChange:j},{default:o(()=>e[28]||(e[28]=[I("仅自己的数据")])),_:1},8,["modelValue"])]),_:1}),a(ae,null,{default:o(()=>[a(Ne,{span:24},{default:o(()=>[a(Y,{modelValue:t(q),"onUpdate:modelValue":e[5]||(e[5]=d=>F(q)?q.value=d:null),clearable:"",placeholder:"输入名称或者接口或者path"},{suffix:o(()=>[a(n,{icon:"Search",type:"info",onClick:y,loading:t(r).filter,disabled:t(r).filter,link:""},null,8,["loading","disabled"])]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(De,{height:"calc(100% - 70px)"},{default:o(()=>[O("div",ut,[a(st,{"data-source":t(V),"onUpdate:dataSource":e[6]||(e[6]=d=>F(V)?V.value=d:null),onNodeDbClick:s,"filter-text":t(q),"onUpdate:filterText":e[7]||(e[7]=d=>F(q)?q.value=d:null),"tree-ref":t(N),"onUpdate:treeRef":e[8]||(e[8]=d=>F(N)?N.value=d:null),onDelNode:i,onMoveNode:m,onEditNode:be,onAddNode:xe,onCurrentNodeChange:ke},null,8,["data-source","filter-text","tree-ref"])])]),_:1})]),right:o(()=>[a(ne,{style:{display:"flex","flex-direction":"column",height:"100%","padding-left":"5px"}},{default:o(()=>[a(Ae,{type:"card",modelValue:t(w),"onUpdate:modelValue":e[9]||(e[9]=d=>F(w)?w.value=d:null),onTabClick:T,onTabChange:_},{default:o(()=>[(k(!0),H(pe,null,$e(t(p),(d,mt)=>(k(),E(Te,{label:d.name,key:d.requestInfo.teststeps[0].step_id,name:d.apiId},{label:o(()=>[a(Se,{"is-dot":"",hidden:!d.modify},{default:o(()=>[O("span",pt,[O("span",{onDblclick:ge=>{_(d.apiId)}},Be(d.name),41,ft),a(n,{onClick:ue(ge=>{u(ge,d.apiId)},["stop"]),icon:"Close",link:""},null,8,["onClick"])])]),_:2},1032,["hidden"])]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"]),t(f)?(k(),H(pe,{key:0},[t(f)?(k(),H("div",ct,[t(f).requestInfo.teststeps[0].step_type===t(C).http?(k(),E(We,{key:0,"step-detail-data":t(f).requestInfo.teststeps[0],"onUpdate:stepDetailData":e[10]||(e[10]=d=>t(f).requestInfo.teststeps[0]=d),"request-container-height":"calc(100vh - 165px)"},null,8,["step-detail-data"])):L("",!0),t(f).requestInfo.teststeps[0].step_type===t(C).websocket?(k(),E(Ke,{key:1,"step-detail-data":t(f).requestInfo.teststeps[0],"onUpdate:stepDetailData":e[11]||(e[11]=d=>t(f).requestInfo.teststeps[0]=d),"step-container-height":"calc(100vh - 245px)"},null,8,["step-detail-data"])):L("",!0)])):L("",!0)],64)):(k(),E(J,{key:1,type:"warning",size:"large"},{default:o(()=>e[29]||(e[29]=[I("请选择api或者新增api")])),_:1}))]),_:1})]),_:1})]),_:1}),a(ie,{title:(ce=t(f))==null?void 0:ce.name,onClose:e[14]||(e[14]=d=>t(r).preSaveDialog=!1),modelValue:t(r).preSaveDialog,"onUpdate:modelValue":e[15]||(e[15]=d=>t(r).preSaveDialog=d)},{default:o(()=>[a(oe,null,{default:o(()=>[a(Y,{modelValue:t(f).name,"onUpdate:modelValue":e[12]||(e[12]=d=>t(f).name=d),placeholder:"请输入名称"},{prepend:o(()=>[a(J,null,{default:o(()=>e[30]||(e[30]=[I("API名称:")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(n,{type:"info",onClick:e[13]||(e[13]=d=>t(r).preSaveDialog=!1)},{default:o(()=>e[31]||(e[31]=[I("取消")])),_:1}),a(n,{type:"primary",onClick:Q,disabled:t(r).saveApi,loading:t(r).saveApi},{default:o(()=>e[32]||(e[32]=[I("保存 ")])),_:1},8,["disabled","loading"])]),_:1},8,["title","modelValue"]),a(ie,{title:t($).name,onClose:e[18]||(e[18]=d=>t(r).preSaveFolderDialog=!1),modelValue:t(r).preSaveFolderDialog,"onUpdate:modelValue":e[19]||(e[19]=d=>t(r).preSaveFolderDialog=d)},{default:o(()=>[a(oe,null,{default:o(()=>[a(Y,{"model-value":t(U)?t(U).name:"根目录",placeholder:"请输入文件夹名称",disabled:""},{prepend:o(()=>[a(J,null,{default:o(()=>e[33]||(e[33]=[I("父级目录:")])),_:1})]),_:1},8,["model-value"]),a(Y,{modelValue:t($).name,"onUpdate:modelValue":e[16]||(e[16]=d=>t($).name=d),placeholder:"请输入文件夹名称",style:{"padding-top":"5px"}},{prepend:o(()=>[a(J,null,{default:o(()=>e[34]||(e[34]=[I("文件夹名称:")])),_:1})]),_:1},8,["modelValue"])]),_:1}),a(n,{type:"info",onClick:e[17]||(e[17]=d=>t(r).preSaveFolderDialog=!1)},{default:o(()=>e[35]||(e[35]=[I("取消")])),_:1}),a(n,{type:"primary",onClick:le,disabled:t(r).saveApi},{default:o(()=>e[36]||(e[36]=[I("保存")])),_:1},8,["disabled"])]),_:1},8,["title","modelValue"]),a(ie,{fullscreen:"",title:"【"+((ve=t(f))==null?void 0:ve.apiId)+"】"+((me=t(f))==null?void 0:me.name),modelValue:t(K).runHistoryDialog,"onUpdate:modelValue":e[20]||(e[20]=d=>t(K).runHistoryDialog=d),"append-to-body":"","destroy-on-close":""},{default:o(()=>[a(ne,{style:{height:"100%"}},{default:o(()=>[a(oe,{style:{"max-height":"calc(100vh - 95px)"}},{default:o(()=>[a(je,{"run-id":t(f).apiId,"view-type":t(Xe).api},null,8,["run-id","view-type"])]),_:1})]),_:1})]),_:1},8,["title","modelValue"])])),[[fe,t(R)]])}}});export{Tt as default};
