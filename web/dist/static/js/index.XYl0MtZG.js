import{af as L,C as he,at as Te,au as ie,r as k,D as Ae,d as g,o as b,c as z,e as l,h as t,f as n,m as H,l as E,av as Ve,p as h,n as O,q as ue,aw as Ee,ax as Me,P as pe,E as Re,ay as T,V as X,F as Ue,J as qe,I as _e,$ as q,a7 as Fe,z as $e,v as Pe,a1 as ye}from"./index.CHnR_MAu.js";import{C as Be,l as ze,_ as He,S as Oe,a as Le,b as We,c as je,g as Je}from"./run-detail.CU1qKOwv.js";import{_ as Ke}from"./edit-label-text.CqCNkUML.js";import{C,H as F,r as Qe,R as Xe}from"./project.BpVuymad.js";import{r as Ye}from"./tools.B8u06WSF.js";import"./data-template.CF-ivY4r.js";import{g as Ge,d as Ze}from"./case.CZLC1pq4.js";import"./run_detail.CgntWMNI.js";import"./table-variables.iSiz_YnM.js";import"./ace-editor.UAWmui2X.js";import"./ResizeObserver.es.B1PUzC5B.js";import"./module.BMNy9Seo.js";import"./env.jLYomLFD.js";function et(I){return L({url:"/hrm/api/mult/tree",method:"get",params:I})}function tt(I){return L({url:"/hrm/api/detail/"+I,method:"get"})}function se(I){return L({url:"/hrm/api",method:"post",data:I})}function re(I){return L({url:"/hrm/api",method:"put",data:I})}function at(I){return L({url:"/hrm/api/"+I,method:"delete"})}function lt(I){return L({url:"/hrm/api/copyAsCase",method:"post",data:I})}const nt=["onDblclick","onClick","onMouseenter","onMouseleave"],ot={key:4},dt=he({__name:"tree-view",props:{dataSource:{},dataSourceModifiers:{},filterText:{},filterTextModifiers:{},treeRef:{},treeRefModifiers:{}},emits:Te(["nodeDbClick","delNode","filter","addNode","moveNode","editNode","currentNodeChange"],["update:dataSource","update:filterText","update:treeRef"]),setup(I,{emit:J}){const Y=ie(I,"dataSource");ie(I,"filterText");const G=ie(I,"treeRef"),A=k({e:null,data:null,node:null,nodeRef:null}),S=Ae({show:!1,x:0,y:0,data:[{title:"新增文件夹",apiType:C.folder,icon:"Menu"},{title:"新增http请求",apiType:C.http,icon:"Menu",divided:!0},{title:"新增websocket请求",apiType:C.websocket,icon:"Menu",divided:!0}],onSelect:i=>{P(A.value.data,i.apiType)}}),M=J,$=(i,s,u,N)=>{};function c(i,s,u,N){i.preventDefault(),A.value.e=i,A.value.data=s,A.value.node=u,A.value.nodeRef=N,S.x=i.clientX,S.y=i.clientY,S.show=!0}const f={key:"apiId",children:"children",label:"name",isLeaf:"isParent",parentId:"parentId"},P=(i,s)=>{if(!i.isParent)return;const u=Ye(10),x={id:null,name:"新增API",children:[],isNew:!0,apiId:u,isParent:s===C.folder,parentId:i.apiId,type:s!==C.folder?F.api:F.folder,apiType:s,edit:!1};i.children||(i.children=[]),i.children.splice(0,0,x),M("addNode",s,x,i)},w=(i,s,u)=>{Re.confirm(`确定删除吗？
对应目录下的所有内容都将被删除`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{console.log(u),at(u.apiId).then(N=>{const x=s.parent,m=x.data.children||x.data,_=m.findIndex(v=>v.apiId===u.apiId);m.splice(_,1),T.success("删除成功"),M("delNode",u)}).catch(()=>{})}).catch(()=>{})},W=(i,s,u)=>{M("nodeDbClick",i,s,u)};function R(i,s,u){return!i||s.name.indexOf(i)!==-1||s.title.indexOf(i)!==-1}const B=(i,s)=>{},r=(i,s,u)=>{},U=(i,s,u)=>{},V=(i,s,u)=>{console.log("tree drag over:",s.label)},K=(i,s,u,N)=>{if(u==="none")return!1},Q=(i,s,u,N)=>{let x=null,m=i.data.apiId,_=0;u==="inner"?x=s.data.apiId:(u==="after"||u==="before")&&(x=s.parent.data.apiId),x!==m&&M("moveNode",x,m,_)},Z=(i,s,u)=>!(!s.data.isParent&&u==="inner"||s.data.apiId===i.data.apiId),j=(i,s,u)=>{M("editNode",i,s,u)},ee=(i,s)=>{M("currentNodeChange",i,s)};return(i,s)=>{const u=g("el-icon"),N=g("el-button"),x=g("el-tree");return b(),z(pe,null,[l(Be,{visible:t(S).show,"onUpdate:visible":s[0]||(s[0]=m=>t(S).show=m),x:t(S).x,y:t(S).y,onSelect:t(S).onSelect,menus:t(S).data},null,8,["visible","x","y","onSelect","menus"]),l(x,{style:{"max-width":"600px"},data:Y.value,"highlight-current":"",props:f,"node-key":"apiId","expand-on-click-node":!1,ref_key:"treeRef",ref:G,"filter-node-method":R,onNodeContextmenu:c,draggable:"","allow-drop":Z,onNodeDragStart:B,onNodeDragEnter:r,onNodeDragLeave:U,onNodeDragOver:V,onNodeDragEnd:K,onNodeDrop:Q,onCurrentChange:ee},{default:n(({node:m,data:_})=>[H("span",{onDblclick:v=>{W(v,m,_)},onClick:v=>{$(_,m,v)},onMouseenter:v=>{m.data.edit=!0},onMouseleave:v=>{m.data.edit=!1}},[_.apiType===t(C).folder?(b(),E(u,{key:0},{default:n(()=>[l(t(Ve))]),_:1})):_.apiType===t(C).http?(b(),E(N,{key:1,type:"success",link:""},{default:n(()=>[h("RQ")]),_:1})):_.apiType===t(C).websocket?(b(),E(N,{key:2,type:"primary",link:""},{default:n(()=>[h("WS")]),_:1})):_.apiType===t(C).webui?(b(),E(N,{key:3,type:"warning",link:""},{default:n(()=>[h("WB")]),_:1})):O("",!0),H("span",null,[l(Ke,{content:_.name,"onUpdate:content":v=>_.name=v,"show-edite":m.data.edit,"onUpdate:showEdite":v=>m.data.edit=v,onEdite:v=>{j(v,_,m)}},null,8,["content","onUpdate:content","show-edite","onUpdate:showEdite","onEdite"])]),m.data.edit?(b(),z("span",ot,[_.apiType===t(C).folder?(b(),E(u,{key:0,color:"green",onClick:ue(v=>{c(v,_,m)},["stop"])},{default:n(()=>[l(t(Ee))]),_:2},1032,["onClick"])):O("",!0),l(u,{color:"red",onClick:ue(v=>w(v,m,_),["stop"])},{default:n(()=>[l(t(Me))]),_:2},1032,["onClick"])])):O("",!0)],40,nt)]),_:1},8,["data"])],64)}}}),it={class:"app-container"},st=H("span",{style:{"flex-grow":"1"}},null,-1),rt={style:{display:"flex"}},ut={style:{margin:"0px",padding:"0px"}},pt=["onDblclick"],ct={key:0,style:{"flex-grow":"1",display:"flex","flex-direction":"column"}},ft=he({name:"Api"}),St=Object.assign(ft,{setup(I){const{proxy:J}=Pe(),{sys_normal_disable:Y}=J.useDict("sys_normal_disable"),{hrm_data_type:G}=J.useDict("hrm_data_type");X("hrm_data_type",G),X("sys_normal_disable",Y);const A=k([]),S=k({}),M=k({}),$=k({parentId:null,name:null}),c=k([]),f=k(c.value[0]||null),P=k(""),w=k(0),W=k({runHistoryDialog:!1}),R=k(!1),B=k(!0),r=k({page:!1,loadApiTree:!1,loadApiInfo:!1,saveApi:!1,debugApi:!1,preSaveDialog:!1,preSaveFolderDialog:!1,filter:!1}),U=k(""),V=k(null);Ue(()=>{j(),Ge().then(d=>{S.value=d.data}),ze().then(d=>{M.value=d.rows})}),X("hrm_comparator_dict",S),X("hrm_case_config_list",M);function K(d){r.value.saveApi=!0;let e=ye(f.value);if(e=structuredClone(e),e.type=F.api,e.requestInfo.teststeps.forEach(a=>{a.result=null}),e.id&&e.apiId&&!e.isNew)d==="copy2case"?lt(e).then(a=>{T({message:"API复制成功",type:"success"})}).catch(a=>{T.error("API复制失败")}).finally(()=>{r.value.saveApi=!1,r.value.preSaveDialog=!1}):re(e).then(a=>{T({message:"API保存成功",type:"success"}),Q(a,e.apiId)}).catch(a=>{T({message:"API保存失败",type:"success"})}).finally(()=>{r.value.saveApi=!1,r.value.preSaveDialog=!1});else{const a=e.apiId;delete e.isNew,delete e.apiId,delete e.id,se(e).then(p=>{T({message:"API保存成功",type:"success"}),Q(p,a)}).finally(()=>{r.value.saveApi=!1,r.value.preSaveDialog=!1})}}function Q(d,e){let a=d;if(a){let p=V.value.getNode(e);p.data.apiId=a.data.apiId,p.data.name=a.data.name,p.data.isNew=!1,p.apiId=a.data.apiId,p.name=a.data.name,c.value.forEach(D=>{D.apiId===e&&(D.apiId=a.data.apiId,w.value=a.data.apiId)})}}function Z(){let d=V.value.getCurrentNode(),e=null;d&&(e=d.apiId,e=V.value.getNode(e)?e:null),r.value.preSaveFolderDialog=!0;let a=$.value;a.type=F.folder,a.apiType=C.folder,a.parentId=e,se(a).then(p=>{e?V.value.getNode(e).data.children.splice(0,0,p.data):A.value.splice(0,0,p.data),T({message:"Folder保存成功",type:"success"})}).finally(()=>{r.value.preSaveFolderDialog=!1})}function j(){R.value=!0,et({onlySelf:B.value}).then(d=>{A.value=d.data}).finally(()=>{R.value=!1})}function ee(d,e,a){if(e.data.isParent)e.expanded=!e.expanded;else{const p=e.data.apiId,D=c.value.findIndex(y=>y.apiId===p);if(D!==-1)w.value=p,f.value=c.value[D],R.value=!1;else{if(R.value=!0,e.data.isNew){let y=Je(e.data.apiType);y.isNew=!0,y.type=e.data.type,y.apiType=e.data.apiType,y.requestInfo.name=e.name,y.parentId=e.data.parentId,y.apiId=e.data.apiId,c.value.push(y),f.value=c.value[c.value.length-1],w.value=y.apiId,c.value[0].isEmpty&&c.value.splice(0,1),R.value=!1;return}tt(e.data.apiId).then(y=>{c.value.push(y.data),f.value=c.value[c.value.length-1],w.value=y.data.apiId,c.value[0].isEmpty&&c.value.splice(0,1),console.log("当前tab："+w.value)}).catch(()=>{}).finally(()=>{R.value=!1})}}}function i(d){const e=c.value.findIndex(a=>a.apiId===d.apiId);e!==-1&&c.value.splice(e,1)}function s(d,e){const a=c.value.findIndex(p=>p.apiId===e);a!==-1&&(c.value.length===1?f.value=!1:c.value.length-1===a?(f.value=c.value[a-1],w.value=f.value.apiId):(f.value=c.value[a+1],w.value=f.value.apiId),c.value.splice(a,1),console.log("删除了tab:"+e))}function u(d,e){}function N(d){const e=c.value.findIndex(a=>a.apiId===d);f.value=c.value[e],w.value=d,V.value.setCurrentKey(d)}function x(){r.value.debugApi=!0;const d=ye(f.value);let e={request:d.requestInfo,type:d.type,name:d.name,caseId:d.apiId};delete e.request.config.result,delete e.request.teststeps[0].result,e.request.config.name=e.name;const a={env:P.value,runType:Xe.api,caseData:e};Ze(a).then(p=>{T.success(p.msg);for(const D in p.data)f.value.requestInfo.teststeps.find(y=>y.step_id===D).result=p.data[D]}).finally(()=>{r.value.debugApi=!1})}function m(){r.value.filter=!0,V.value.filter(U.value),r.value.filter=!1}const _=(d,e,a)=>{re({parentId:d,apiId:e}).then(p=>{T.success("移动节点成功")}).catch(p=>{})},v=(d,e,a)=>{re({name:e.name,apiId:e.apiId}).then(p=>{T.success("修改成功")}).catch(p=>{})},Ie=(d,e,a)=>{if(d!==C.folder)return;let p=d===C.folder?F.folder:F.api;se({type:p,apiType:d,name:e.name,parentId:a.apiId}).then(D=>{T.success("文件夹【"+e.name+"】新增成功")}).catch(D=>{})};function be(){if(!f.value){T.warning("请先选择一个接口");return}W.value.runHistoryDialog=!0}function xe(d,e){d.type===F.folder||c.value.findIndex(p=>p.apiId===d.apiId)===-1||(w.value=d.apiId,N(d.apiId))}return(d,e)=>{var fe,me,ve;const a=g("el-button"),p=g("el-dropdown-item"),D=g("el-dropdown-menu"),y=g("el-dropdown"),te=g("el-row"),ke=g("el-checkbox"),ae=g("el-input"),Ce=g("el-col"),we=g("el-scrollbar"),Ne=g("el-badge"),De=g("el-tab-pane"),Se=g("el-tabs"),le=g("el-text"),ne=g("el-container"),oe=g("el-main"),de=g("el-dialog"),ce=qe("loading");return _e((b(),z("div",it,[l(te,null,{default:n(()=>[l(a,{size:"small",onClick:j,icon:"RefreshRight"}),l(a,{size:"small",onClick:e[0]||(e[0]=o=>t(r).preSaveFolderDialog=!0),type:"primary"},{default:n(()=>[h("新增文件夹")]),_:1}),st,_e((b(),E(y,{size:"small","split-button":"",type:"primary",onClick:e[3]||(e[3]=o=>t(r).preSaveDialog=!0),disabled:t(r).saveApi},{dropdown:n(()=>[l(D,null,{default:n(()=>[l(p,{onClick:e[1]||(e[1]=o=>{K("copy2case")})},{default:n(()=>[h("另存为用例")]),_:1}),l(p,{onClick:e[2]||(e[2]=o=>console.log("复制API"))},{default:n(()=>[h("复制")]),_:1}),l(p,{onClick:be},{default:n(()=>[h("执行历史")]),_:1})]),_:1})]),default:n(()=>[h(" 保存 ")]),_:1},8,["disabled"])),[[ce,t(r).saveApi]]),l(a,{size:"small",onClick:x,loading:t(r).debugApi,disabled:t(r).debugApi,type:"warning"},{default:n(()=>[h(" 调试 ")]),_:1},8,["loading","disabled"]),l(He,{"selected-env":t(P),"onUpdate:selectedEnv":e[4]||(e[4]=o=>q(P)?P.value=o:null),size:"small",disable:t(r).debugApi},null,8,["selected-env","disable"])]),_:1}),l(ne,null,{default:n(()=>[l(Oe,{"left-width":"250px","window-height":"calc(100vh - 156px)"},{left:n(()=>[l(te,null,{default:n(()=>[l(ke,{modelValue:t(B),"onUpdate:modelValue":e[5]||(e[5]=o=>q(B)?B.value=o:null),onChange:j},{default:n(()=>[h("仅自己的数据")]),_:1},8,["modelValue"])]),_:1}),l(te,null,{default:n(()=>[l(Ce,{span:24},{default:n(()=>[l(ae,{modelValue:t(U),"onUpdate:modelValue":e[6]||(e[6]=o=>q(U)?U.value=o:null),clearable:"",placeholder:"输入名称或者接口或者path"},{suffix:n(()=>[l(a,{icon:"Search",type:"info",onClick:m,loading:t(r).filter,disabled:t(r).filter,link:""},null,8,["loading","disabled"])]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(we,{height:"calc(100% - 70px)"},{default:n(()=>[H("div",rt,[l(dt,{"data-source":t(A),"onUpdate:dataSource":e[7]||(e[7]=o=>q(A)?A.value=o:null),onNodeDbClick:ee,"filter-text":t(U),"onUpdate:filterText":e[8]||(e[8]=o=>q(U)?U.value=o:null),"tree-ref":t(V),"onUpdate:treeRef":e[9]||(e[9]=o=>q(V)?V.value=o:null),onDelNode:i,onMoveNode:_,onEditNode:v,onAddNode:Ie,onCurrentNodeChange:xe},null,8,["data-source","filter-text","tree-ref"])])]),_:1})]),right:n(()=>[l(ne,{style:{display:"flex","flex-direction":"column",height:"100%","padding-left":"5px"}},{default:n(()=>[l(Se,{type:"card",modelValue:t(w),"onUpdate:modelValue":e[10]||(e[10]=o=>q(w)?w.value=o:null),onTabClick:u,onTabChange:N},{default:n(()=>[(b(!0),z(pe,null,Fe(t(c),(o,mt)=>(b(),E(De,{label:o.name,key:o.requestInfo.teststeps[0].step_id,name:o.apiId},{label:n(()=>[l(Ne,{"is-dot":"",hidden:!o.modify},{default:n(()=>[H("span",ut,[H("span",{onDblclick:ge=>{N(o.apiId)}},$e(o.name),41,pt),l(a,{onClick:ue(ge=>{s(ge,o.apiId)},["stop"]),icon:"Close",link:""},null,8,["onClick"])])]),_:2},1032,["hidden"])]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"]),t(f)?(b(),z(pe,{key:0},[t(f)?(b(),z("div",ct,[t(f).requestInfo.teststeps[0].step_type===t(C).http?(b(),E(Le,{key:0,"step-detail-data":t(f).requestInfo.teststeps[0],"onUpdate:stepDetailData":e[11]||(e[11]=o=>t(f).requestInfo.teststeps[0]=o),"edit-height":"calc(100vh - 332px)"},null,8,["step-detail-data"])):O("",!0),t(f).requestInfo.teststeps[0].step_type===t(C).websocket?(b(),E(We,{key:1,"step-detail-data":t(f).requestInfo.teststeps[0],"onUpdate:stepDetailData":e[12]||(e[12]=o=>t(f).requestInfo.teststeps[0]=o),"edit-height":"calc(100vh - 385px)"},null,8,["step-detail-data"])):O("",!0)])):O("",!0)],64)):(b(),E(le,{key:1,type:"warning",size:"large"},{default:n(()=>[h("请选择api或者新增api")]),_:1}))]),_:1})]),_:1})]),_:1}),l(de,{title:(fe=t(f))==null?void 0:fe.name,onClose:e[15]||(e[15]=o=>t(r).preSaveDialog=!1),modelValue:t(r).preSaveDialog,"onUpdate:modelValue":e[16]||(e[16]=o=>t(r).preSaveDialog=o)},{default:n(()=>[l(oe,null,{default:n(()=>[l(ae,{modelValue:t(f).name,"onUpdate:modelValue":e[13]||(e[13]=o=>t(f).name=o),placeholder:"请输入名称"},{prepend:n(()=>[l(le,null,{default:n(()=>[h("API名称:")]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(a,{type:"info",onClick:e[14]||(e[14]=o=>t(r).preSaveDialog=!1)},{default:n(()=>[h("取消")]),_:1}),l(a,{type:"primary",onClick:K,disabled:t(r).saveApi,loading:t(r).saveApi},{default:n(()=>[h("保存 ")]),_:1},8,["disabled","loading"])]),_:1},8,["title","modelValue"]),l(de,{title:t($).name,onClose:e[19]||(e[19]=o=>t(r).preSaveFolderDialog=!1),modelValue:t(r).preSaveFolderDialog,"onUpdate:modelValue":e[20]||(e[20]=o=>t(r).preSaveFolderDialog=o)},{default:n(()=>[l(oe,null,{default:n(()=>[l(ae,{modelValue:t($).name,"onUpdate:modelValue":e[17]||(e[17]=o=>t($).name=o),placeholder:"请输入文件夹名称"},{prepend:n(()=>[l(le,null,{default:n(()=>[h("文件夹名称:")]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(a,{type:"info",onClick:e[18]||(e[18]=o=>t(r).preSaveFolderDialog=!1)},{default:n(()=>[h("取消")]),_:1}),l(a,{type:"primary",onClick:Z,disabled:t(r).saveApi},{default:n(()=>[h("保存")]),_:1},8,["disabled"])]),_:1},8,["title","modelValue"]),l(de,{fullscreen:"",title:"【"+((me=t(f))==null?void 0:me.apiId)+"】"+((ve=t(f))==null?void 0:ve.name),modelValue:t(W).runHistoryDialog,"onUpdate:modelValue":e[21]||(e[21]=o=>t(W).runHistoryDialog=o),"append-to-body":"","destroy-on-close":""},{default:n(()=>[l(ne,{style:{height:"100%"}},{default:n(()=>[l(oe,{style:{"max-height":"calc(100vh - 95px)"}},{default:n(()=>[l(je,{"run-id":t(f).apiId,"view-type":t(Qe).api},null,8,["run-id","view-type"])]),_:1})]),_:1})]),_:1},8,["title","modelValue"])])),[[ce,t(R)]])}}});export{St as default};
