{"version":3,"file":"case-table-query.CSSzayYD.js","sources":["../../../src/components/hrm/util-data-table/case-table-query.vue"],"sourcesContent":["<template>\r\n  <div class=\"app-container\">\r\n    <el-form :model=\"queryParams\" ref=\"queryRef\" :inline=\"true\" v-show=\"showSearch\">\r\n      <el-form-item label=\"所属项目\" prop=\"projectId\">\r\n        <el-select v-model=\"queryParams.projectId\" placeholder=\"请选择\" @change=\"resetModule\" clearable filterable\r\n                   style=\"width: 150px\">\r\n          <el-option\r\n              v-for=\"option in projectOptions\"\r\n              :key=\"option.projectId\"\r\n              :label=\"option.projectName\"\r\n              :value=\"option.projectId\">\r\n          </el-option>\r\n        </el-select>\r\n      </el-form-item>\r\n      <el-form-item label=\"所属模块\" prop=\"moduleId\">\r\n        <el-select v-model=\"queryParams.moduleId\" placeholder=\"请选择\" clearable filterable style=\"width: 150px\">\r\n          <el-option\r\n              v-for=\"option in moduleOptions\"\r\n              :key=\"option.moduleId\"\r\n              :label=\"option.moduleName\"\r\n              :value=\"option.moduleId\">\r\n          </el-option>\r\n        </el-select>\r\n      </el-form-item>\r\n      <el-form-item :label=\"dataName+'ID'\" prop=\"caseId\">\r\n        <el-input\r\n            v-model=\"queryParams.caseId\"\r\n            :placeholder=\"'请输入'+dataName+'名称'\"\r\n            clearable\r\n            style=\"width: 200px\"\r\n            @keyup.enter=\"handleQuery\"\r\n        />\r\n      </el-form-item>\r\n      <el-form-item :label=\"dataName+'名称'\" prop=\"caseName\">\r\n        <el-input\r\n            v-model=\"queryParams.caseName\"\r\n            :placeholder=\"'请输入'+dataName+'名称'\"\r\n            clearable\r\n            style=\"width: 200px\"\r\n            @keyup.enter=\"handleQuery\"\r\n        />\r\n      </el-form-item>\r\n      <el-form-item label=\"状态\" prop=\"status\">\r\n        <el-select v-model=\"queryParams.status\" :placeholder=\"dataName+'状态'\" clearable style=\"width: 100px\">\r\n          <el-option\r\n              v-for=\"dict in qtr_case_status\"\r\n              :key=\"dict.value * 1\"\r\n              :label=\"dict.label\"\r\n              :value=\"dict.value * 1\"\r\n          />\r\n        </el-select>\r\n      </el-form-item>\r\n      <el-form-item>\r\n        <el-checkbox v-model=\"onlySelf\" @change=\"handleQuery\">仅自己的数据</el-checkbox>\r\n      </el-form-item>\r\n      <el-form-item>\r\n        <el-button type=\"primary\" icon=\"Search\" @click=\"handleQuery\" :loading=\"loading.page\" :disabled=\"loading.page\">\r\n          搜索\r\n        </el-button>\r\n        <el-button type=\"default\" icon=\"Refresh\" @click=\"resetQuery\">重置</el-button>\r\n      </el-form-item>\r\n    </el-form>\r\n\r\n    <el-row :gutter=\"10\" class=\"mb8\">\r\n      <slot name=\"table-tool\"></slot>\r\n      <right-toolbar v-model:showSearch=\"showSearch\" @queryTable=\"getList\"></right-toolbar>\r\n    </el-row>\r\n\r\n    <el-table v-loading=\"loading.page\"\r\n              ref=\"tableRef\"\r\n              :data=\"caseList\"\r\n              @select=\"handleSelect\"\r\n              @select-all=\"handleSelectAll\"\r\n              @selection-change=\"handleSelectionChange\"\r\n              border\r\n              table-layout=\"fixed\"\r\n              max-height=\"calc(100vh - 280px)\"\r\n    >\r\n      <el-table-column type=\"selection\" width=\"55\" align=\"center\"/>\r\n      <el-table-column :label=\"dataName+'ID'\" prop=\"caseId\" width=\"150px\"/>\r\n      <el-table-column :label=\"dataName+'名称'\" prop=\"caseName\" width=\"auto\" min-width=\"200px\"/>\r\n      <el-table-column label=\"所属项目\" prop=\"projectName\">\r\n        <template #default=\"scope\">\r\n          <span>{{ nameOrGlob(scope.row.projectName) }}</span>\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column label=\"所属模块\" prop=\"moduleName\">\r\n        <template #default=\"scope\">\r\n          <span>{{ nameOrGlob(scope.row.moduleName) }}</span>\r\n        </template>\r\n      </el-table-column>\r\n      <!--         <el-table-column label=\"用例排序\" align=\"center\" prop=\"sort\" />-->\r\n      <el-table-column label=\"状态\" align=\"center\" prop=\"status\" width=\"120px\">\r\n        <template #default=\"scope\">\r\n          <slot name=\"caseStatus\" :scope=\"scope\">\r\n            <DictTag :options=\"qtr_case_status\" :value=\"scope.row.status\"></DictTag>\r\n          </slot>\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column label=\"创建人\" align=\"center\" prop=\"createBy\" width=\"80px\"></el-table-column>\r\n      <el-table-column label=\"创建时间\" align=\"center\" prop=\"createTime\" class-name=\"small-padding fixed-width\"\r\n                       width=\"150px\">\r\n        <template #default=\"scope\">\r\n          <span>{{ parseTime(scope.row.createTime) }}</span>\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column label=\"更新时间\" align=\"center\" prop=\"createTime\" class-name=\"small-padding fixed-width\"\r\n                       width=\"150px\">\r\n        <template #default=\"scope\">\r\n          <span>{{ parseTime(scope.row.updateTime) }}</span>\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column label=\"操作\" width=\"170\" align=\"center\" class-name=\"small-padding fixed-width\" fixed=\"right\"\r\n                       v-if=\"$slots.tableOperate\">\r\n        <template #default=\"scope\">\r\n          <slot name=\"tableOperate\" :scope=\"scope\"></slot>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <pagination\r\n        v-show=\"total > 0 && showPagination\"\r\n        :total=\"total\"\r\n        v-model:page=\"queryParams.pageNum\"\r\n        v-model:limit=\"queryParams.pageSize\"\r\n        @pagination=\"getList\"\r\n    />\r\n\r\n  </div>\r\n</template>\r\n\r\n<script setup>\r\nimport {listCase} from \"@/api/hrm/case\";\r\nimport {selectModulList} from \"@/api/hrm/module\";\r\nimport {listProject} from \"@/api/hrm/project\";\r\nimport {HrmDataTypeEnum} from \"@/components/hrm/enum.js\";\r\nimport DictTag from \"@/components/DictTag/index.vue\";\r\n// import JsonEditorVue from \"json-editor-vue3\";\r\n\r\nconst {proxy} = getCurrentInstance();\r\n// const {sys_normal_disable} = proxy.useDict(\"sys_normal_disable\");\r\n// const {hrm_data_type} = proxy.useDict(\"hrm_data_type\");\r\nconst {qtr_case_status} = proxy.useDict(\"qtr_case_status\");\r\n\r\nconst props = defineProps({\r\n  dataType: {type: Number, default: HrmDataTypeEnum.case},\r\n  showPagination: {type: Boolean, default: true},\r\n  checkedIds: {type: Array, default: []}\r\n});\r\n\r\nconst emits = defineEmits(['selectChange']);\r\ndefineExpose({handleQuery, getSelectedIds});\r\n\r\n\r\n/*\r\n* 区分用例还是配置\r\n* */\r\nconst dataName = computed(() => {\r\n  return props.dataType === HrmDataTypeEnum.case ? \"用例\" : \"配置\";\r\n});\r\n\r\n// provide(\"hrm_data_type\", hrm_data_type);\r\n// provide('sys_normal_disable', sys_normal_disable);\r\nprovide('qtr_case_status', qtr_case_status);\r\n\r\nconst tableRef = ref(null);\r\nconst caseList = ref([]);\r\nconst projectOptions = ref([]);\r\nconst moduleOptions = ref([]);\r\nconst open = ref(false);\r\n// const loading = ref(true);\r\nconst showSearch = ref(true);\r\nconst allSelectIds = ref([]);\r\nconst single = ref(true);\r\nconst multiple = ref(true);\r\nconst total = ref(0);\r\nconst title = ref(\"\");\r\nconst onlySelf = ref(true);\r\nconst _selectIds = ref(new Set());\r\n\r\nconst queryParams = toRef({\r\n  pageNum: 1,\r\n  pageSize: 10,\r\n  type: props.dataType,\r\n  caseId: undefined,\r\n  caseName: undefined,\r\n  projectId: undefined,\r\n  moduleId: undefined,\r\n  status: undefined,\r\n  onlySelf: onlySelf\r\n});\r\n\r\nconst loading = ref({\r\n  page: false,\r\n  edite: false,\r\n  run: false,\r\n  copy: false\r\n});\r\n\r\n/*\r\n* 显示真实名称还是“全局”，没有设置项目和模块的显示未全局\r\n* */\r\nfunction nameOrGlob(val) {\r\n  return val ? val : \"全局\";\r\n}\r\n\r\n/** 查询用例列表 */\r\nfunction getList() {\r\n  loading.value.page = true;\r\n  // console.log(tableRef.value.getSelectionRows());\r\n  listCase(queryParams.value).then(response => {\r\n    caseList.value = response.rows;\r\n    total.value = response.total;\r\n    nextTick(() => {\r\n      // if (tableRef.value) {\r\n      //   tableRef.value.clearSelection();\r\n      // }\r\n\r\n      if (allSelectIds.value && allSelectIds.value.length > 0) {\r\n        if (tableRef.value && caseList.value) {\r\n          caseList.value.forEach(item => {\r\n            if (allSelectIds.value.some(dataId => dataId === item.caseId)) {\r\n              tableRef.value.toggleRowSelection(item, true);\r\n            } else {\r\n              tableRef.value.toggleRowSelection(item, false);\r\n            }\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }).finally(() => {\r\n    loading.value.page = false;\r\n  });\r\n}\r\n\r\n/** 查询项目列表 */\r\nfunction getProjectSelect() {\r\n  listProject({isPage: false}).then(response => {\r\n    projectOptions.value = response.data;\r\n  });\r\n}\r\n\r\n/** 查询模块列表 */\r\nfunction getModuleSelect() {\r\n  selectModulList(queryParams.value).then(response => {\r\n    moduleOptions.value = response.data;\r\n  });\r\n}\r\n\r\n/**重置查询条件所属模块下拉框*/\r\nfunction resetModule() {\r\n  queryParams.value.moduleId = undefined;\r\n  getModuleSelect();\r\n}\r\n\r\n/** 搜索按钮操作 */\r\nfunction handleQuery() {\r\n  queryParams.value.pageNum = 1;\r\n  getList();\r\n}\r\n\r\n/** 重置按钮操作 */\r\nfunction resetQuery() {\r\n  proxy.resetForm(\"queryRef\");\r\n  handleQuery();\r\n}\r\n\r\nfunction handleSelect(selection, row) {\r\n  let pageIds = caseList.value.map(item => item.caseId);\r\n  let pageSelectIds = selection.map(item => item.caseId);\r\n  let delIds = pageIds.filter(item=> !pageSelectIds.includes(item));\r\n  pageSelectIds.forEach((dataId) => {\r\n    if (!allSelectIds.value.some((caseId) => caseId === dataId)) {\r\n        allSelectIds.value.push(dataId);\r\n      }\r\n  });\r\n  allSelectIds.value = allSelectIds.value.filter(item => !delIds.includes(item));\r\n}\r\n\r\n/** 多选框选中数据 */\r\nfunction handleSelectionChange(selection) {\r\n  // console.log(selection);\r\n  emits('selectChange', selection);\r\n  // let pageSelectIds = selection.map(item => item.caseId);\r\n  // let pageIds = caseList.value.map(item => item.caseId);\r\n  // 从选中数据中排除当前页的数据\r\n  // allSelectIds.value = allSelectIds.value.filter((dataId) => !caseList.value.some(item=>item.caseId === dataId));\r\n\r\n  // 添加当前页选中的数据\r\n  // selection.forEach((item) =>{\r\n  //   if (!allSelectIds.value.some((caseId)=>caseId === item.caseId)){\r\n  //     allSelectIds.value.push(item.caseId);\r\n  //   }\r\n  // });\r\n\r\n  single.value = selection.length !== 1;\r\n  multiple.value = !selection.length;\r\n}\r\n\r\nfunction handleSelectAll(selection) {\r\n  let pageSelectIds = selection.map(item => item.caseId);\r\n  if (pageSelectIds && pageSelectIds.length > 0) {\r\n    pageSelectIds.forEach((item) => {\r\n      if (!allSelectIds.value.some((caseId) => caseId === item)) {\r\n        allSelectIds.value.push(item);\r\n      }\r\n    });\r\n  } else {\r\n    let pageIds = caseList.value.map(item => item.caseId);\r\n    allSelectIds.value = allSelectIds.value.filter(item => !pageIds.includes(item));\r\n  }\r\n\r\n}\r\n\r\nfunction getSelectedIds() {\r\n  return allSelectIds.value;\r\n}\r\n\r\nwatch(() => props.checkedIds, (newValue) => {\r\n  console.log(\"数据变化了\");\r\n  // allSelectIds.value = newValue;\r\n}, {deep: true});\r\n\r\n\r\nonMounted(() => {\r\n  allSelectIds.value = toRaw(props.checkedIds);\r\n  // _selectIds.value.clear();\r\n  // props.checkedIds.forEach(item => _selectIds.value.add(item));\r\n  getProjectSelect();\r\n  getList();\r\n\r\n});\r\n\r\n</script>\r\n"],"names":["proxy","getCurrentInstance","qtr_case_status","props","__props","emits","__emit","__expose","handleQuery","getSelectedIds","dataName","computed","HrmDataTypeEnum","provide","tableRef","ref","caseList","projectOptions","moduleOptions","showSearch","allSelectIds","single","multiple","total","onlySelf","queryParams","toRef","loading","nameOrGlob","val","getList","listCase","response","nextTick","item","dataId","getProjectSelect","listProject","getModuleSelect","selectModulList","resetModule","resetQuery","handleSelect","selection","row","pageIds","pageSelectIds","delIds","caseId","handleSelectionChange","handleSelectAll","watch","newValue","onMounted","toRaw"],"mappings":"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"}